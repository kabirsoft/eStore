@page "/orders/{Id:guid}"
@using eStore.Shared.Dtos
@using eStore.Client.Services.OrderService
@using eStore.Client.Services.PaymentService
@using eStore.Shared.Enums

@inject IPaymentService PaymentService
@inject IOrderService OrderService
@inject NavigationManager Nav

<h3>Order Details</h3>

@if (order is null && !notFound)
{
    <p>Loading...</p>
}
else if (notFound)
{
    <p>Order not found.</p>
}
else
{
    <p><strong>OrderId:</strong> @order!.Id</p>
    <p><strong>Product:</strong> @order.ProductName</p>
    <p><strong>Quantity:</strong> @order.Quantity</p>
    <p><strong>Total:</strong> @(order.TotalOre / 100.0m) @order.Currency</p>
    <p><strong>Status:</strong> @order.Status</p>
    <p><strong>Customer:</strong> @order.CustomerName (@order.CustomerEmail)</p>
    <p><strong>Created:</strong> @order.CreatedUtc</p>
}

<button @onclick="PayWithStripe">Pay with card (Stripe)</button>
<button style="margin-left:10px" @onclick="PayWithVipps">Pay with Vipps</button>
<button style="margin-left:10px" @onclick="PayWithPayPal">PayPal</button>


<p style="margin-top:15px">
    <a href="/products">Back to products</a>
</p>

@code {
    [Parameter] public Guid Id { get; set; }

    private OrderDto? order;
    private bool notFound;

    protected override async Task OnInitializedAsync()
    {
        order = await OrderService.GetOrderByIdAsync(Id);
        notFound = order is null;
    }

    private async Task PayWithStripe()
    {
        if (order is null) return;

        var url = await PaymentService.CreateCheckoutUrlAsync(order.Id, PaymentProvider.Stripe);
        Nav.NavigateTo(url, forceLoad: true);// redirects to Stripe
    }

    private async Task PayWithVipps()
    {
        if (order is null) return;

        var url = await PaymentService.CreateCheckoutUrlAsync(order.Id, PaymentProvider.Vipps);
        Nav.NavigateTo(url, forceLoad: true);
    }

    private async Task PayWithPayPal()
    {
        if (order is null) return;

        var url = await PaymentService.CreateCheckoutUrlAsync(order.Id, PaymentProvider.PayPal);
        Nav.NavigateTo(url, forceLoad: true);
    }

}